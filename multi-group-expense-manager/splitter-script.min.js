class LocalFileStorage{constructor(){this.directoryHandle=null;this.fileHandle=null;this.isSupported='showDirectoryPicker'in window;this.dataFileName='expense_splitter_data.json'}async chooseDirectory(){if(!this.isSupported)throw new Error('File System Access API not supported in this browser');try{this.directoryHandle=await window.showDirectoryPicker({mode:'readwrite'});await this.ensureDataFile();return!0}catch(t){if('AbortError'!==t.name)throw console.error('Error choosing directory:',t),t;return!1}}async ensureDataFile(){if(!this.directoryHandle)return;try{this.fileHandle=await this.directoryHandle.getFileHandle(this.dataFileName)}catch(t){if('NotFoundError'===t.name)this.fileHandle=await this.directoryHandle.getFileHandle(this.dataFileName,{create:!0}),await this.saveData({groups:[],friends:[],expenses:[],settlements:[],currentGroupId:'default',metadata:{version:'2.0',created:new Date().toISOString(),lastModified:new Date().toISOString()}});else throw t}}async saveData(t){if(!this.fileHandle)throw new Error('No file selected. Please choose a folder first.');try{t.metadata={...t.metadata,lastModified:new Date().toISOString(),version:'2.0'};const e=await this.fileHandle.createWritable();await e.write(JSON.stringify(t,null,2)),await e.close();return!0}catch(t){throw console.error('Error saving data:',t),t}}async loadData(){if(!this.fileHandle)throw new Error('No file selected. Please choose a folder first.');try{const t=await this.fileHandle.getFile(),e=await t.text();return JSON.parse(e)}catch(t){throw console.error('Error loading data:',t),t}}async createBackup(){if(this.directoryHandle&&this.fileHandle)try{const t=await this.loadData(),e=new Date().toISOString().replace(/[:.]/g,'-'),a=`expense_splitter_backup_${e}.json`,i=await this.directoryHandle.getFileHandle(a,{create:!0}),r=await i.createWritable();return await r.write(JSON.stringify(t,null,2)),await r.close(),a}catch(t){console.error('Error creating backup:',t)}}getStoragePath(){return this.directoryHandle?this.directoryHandle.name:null}isReady(){return this.directoryHandle&&this.fileHandle}}class ExpenseSplitter{constructor(){this.groups=[],this.friends=[],this.expenses=[],this.settlements=[],this.currentGroupId='default',this.fileStorage=new LocalFileStorage,this.autoSaveEnabled=!0,this.lastSaveTime=null,this.initializeApp(),this.loadFromStorage()}initializeApp(){this.setupEventListeners(),this.checkBrowserCompatibility(),this.ensureDefaultGroup(),this.updateStorageUI(),this.displayGroups(),this.updateGroupStats(),this.setTodayDate(),this.displayFriends(),this.updatePaidByOptions(),this.updateGroupOptions(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.updateSplitDetails()}checkBrowserCompatibility(){const t=document.getElementById('compatibility-warning'),e=document.getElementById('choose-folder-btn');this.fileStorage.isSupported||(t.classList.remove('hidden'),e.disabled=!0,e.innerHTML='<i class="fas fa-times"></i> Not Supported',e.title='File System Access API not supported in this browser')}async chooseFolderLocation(){try{const t=await this.fileStorage.chooseDirectory();if(t){this.updateStorageUI();try{await this.loadFromFile()}catch{console.log('No existing data found, starting fresh'),this.saveToFile()}this.showNotification('Storage location selected successfully!','success')}}catch(t){console.error('Error choosing folder:',t),t.message.includes('not supported')?this.showNotification('File storage not supported in this browser. Try Chrome/Edge.','error'):this.showNotification('Error selecting folder location','error')}}async saveToFile(){if(!this.fileStorage.isReady())return void this.showNotification('Please choose a folder location first','error');try{const t={groups:this.groups,friends:this.friends,expenses:this.expenses,settlements:this.settlements,currentGroupId:this.currentGroupId};await this.fileStorage.saveData(t),this.lastSaveTime=new Date,this.updateStorageUI(),this.autoSaveEnabled||this.showNotification('Data saved successfully!','success')}catch(t){console.error('Error saving to file:',t),this.showNotification('Error saving data to file','error')}}async loadFromFile(){if(!this.fileStorage.isReady())return void this.showNotification('Please choose a folder location first','error');try{const t=await this.fileStorage.loadData();t&&(this.groups=t.groups||[],this.friends=t.friends||[],this.expenses=t.expenses||[],this.settlements=t.settlements||[],this.currentGroupId=t.currentGroupId||'default',this.expenses.forEach(t=>{t.date=new Date(t.date),t.createdAt=new Date(t.createdAt)}),this.settlements.forEach(t=>{t.date=new Date(t.date),t.createdAt=new Date(t.createdAt)}),this.friends.forEach(t=>{t.createdAt=new Date(t.createdAt)}),this.groups.forEach(t=>{t.createdAt=new Date(t.createdAt)}),this.ensureDefaultGroup(),this.displayGroups(),this.updateGroupStats(),this.displayFriends(),this.updatePaidByOptions(),this.updateGroupOptions(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.updateSplitDetails(),this.showNotification('Data loaded successfully!','success'))}catch(t){console.error('Error loading from file:',t),this.showNotification('Error loading data from file','error')}}updateStorageUI(){const t=document.getElementById('storage-status'),e=document.getElementById('storage-path'),a=document.getElementById('save-data-btn'),i=document.getElementById('last-save-time'),r=document.getElementById('auto-save-toggle');this.fileStorage.isReady()?(t.textContent='âœ…',e.textContent=`Saving to: ${this.fileStorage.getStoragePath()}/${this.fileStorage.dataFileName}`,a.disabled=!1):(t.textContent='ðŸ“',e.textContent='Click "Choose Folder" to select where to save your data',a.disabled=!0),r.checked=this.autoSaveEnabled,i.textContent=this.lastSaveTime?this.lastSaveTime.toLocaleString():'Never'}ensureDefaultGroup(){this.groups.find(t=>'default'===t.id)||this.groups.unshift({id:'default',name:'Default Group',createdAt:new Date,description:'Default group for general expenses'})}addGroup(){const t=document.getElementById('new-group-name'),e=t.value.trim();if(!e)return void this.showNotification('Please enter a group/trip name','error');if(this.groups.some(t=>t.name.toLowerCase()===e.toLowerCase()))return void this.showNotification('Group name already exists','error');const a={id:Date.now().toString(),name:e,createdAt:new Date,description:`Group created for ${e}`};this.groups.push(a),this.saveToStorage(),t.value='',this.displayGroups(),this.switchGroup(a.id),this.showNotification(`Group "${e}" created successfully!`,'success')}switchGroup(t){this.currentGroupId=t,this.displayGroups(),this.updateGroupStats(),this.displayFriends(),this.updatePaidByOptions(),this.updateGroupOptions(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.updateSplitDetails(),this.saveToStorage()}deleteCurrentGroup(){if('default'===this.currentGroupId)return void this.showNotification('Cannot delete the default group','error');const t=this.groups.find(t=>t.id===this.currentGroupId);if(!t)return;const e=this.expenses.filter(t=>t.groupId===this.currentGroupId);if(e.length>0)return void this.showNotification('Cannot delete group with existing expenses','error');confirm(`Delete group "${t.name}"? This action cannot be undone.`)&&(this.groups=this.groups.filter(e=>e.id!==this.currentGroupId),this.currentGroupId='default',this.saveToStorage(),this.switchGroup('default'),this.showNotification(`Group "${t.name}" deleted successfully!`,'success'))}displayGroups(){const t=document.getElementById('group-selector');t.innerHTML='',this.groups.forEach(e=>{const a=document.createElement('option');a.value=e.id,a.textContent=e.name,t.appendChild(a)}),t.value=this.currentGroupId;const e=document.getElementById('delete-group-btn');e.disabled='default'===this.currentGroupId,e.style.opacity='default'===this.currentGroupId?'0.5':'1'}updateGroupOptions(){const t=document.getElementById('expense-group');t.innerHTML='',this.groups.forEach(e=>{const a=document.createElement('option');a.value=e.id,a.textContent=e.name,t.appendChild(a)}),t.value=this.currentGroupId}updateGroupStats(){const t=this.getCurrentGroupFriends(),e=this.getCurrentGroupExpenses(),a=e.reduce((t,e)=>t+e.amount,0);document.getElementById('group-friends-count').textContent=t.length,document.getElementById('group-expenses-count').textContent=e.length,document.getElementById('group-total-amount').textContent=a.toFixed(2)}getCurrentGroupFriends(){return this.friends.filter(t=>t.groupId===this.currentGroupId)}getCurrentGroupExpenses(){return this.expenses.filter(t=>t.groupId===this.currentGroupId)}setupEventListeners(){document.getElementById('choose-folder-btn').addEventListener('click',()=>this.chooseFolderLocation()),document.getElementById('save-data-btn').addEventListener('click',()=>this.saveToFile()),document.getElementById('load-data-btn').addEventListener('click',()=>this.loadFromFile()),document.getElementById('auto-save-toggle').addEventListener('change',t=>{this.autoSaveEnabled=t.target.checked,this.updateStorageUI()}),document.getElementById('add-group-btn').addEventListener('click',()=>this.addGroup()),document.getElementById('new-group-name').addEventListener('keypress',t=>{'Enter'===t.key&&(t.preventDefault(),this.addGroup())}),document.getElementById('group-selector').addEventListener('change',t=>this.switchGroup(t.target.value)),document.getElementById('delete-group-btn').addEventListener('click',()=>this.deleteCurrentGroup()),document.getElementById('add-friend-btn').addEventListener('click',()=>this.addFriend()),document.getElementById('friend-name').addEventListener('keypress',t=>{'Enter'===t.key&&(t.preventDefault(),this.addFriend())}),document.getElementById('expense-form').addEventListener('submit',t=>{t.preventDefault(),this.addExpense()}),document.querySelectorAll('input[name="split-type"]').forEach(t=>t.addEventListener('change',()=>this.updateSplitDetails())),document.getElementById('expense-amount').addEventListener('input',()=>this.updateSplitDetails()),document.getElementById('export-expenses-btn').addEventListener('click',()=>this.exportExpenses()),document.getElementById('export-balances-btn').addEventListener('click',()=>this.exportBalanceSummary()),document.getElementById('export-expense-summary-btn').addEventListener('click',()=>this.exportExpenseSummary()),document.getElementById('export-all-data-btn').addEventListener('click',()=>this.exportAllData()),document.getElementById('filter-group').addEventListener('change',()=>this.displayExpenses()),document.getElementById('filter-category').addEventListener('change',()=>this.displayExpenses()),document.getElementById('filter-date-range').addEventListener('change',()=>this.displayExpenses()),document.getElementById('import-data-btn').addEventListener('click',()=>document.getElementById('import-file-input').click()),document.getElementById('import-file-input').addEventListener('change',t=>this.importData(t.target.files[0])),document.getElementById('clear-all-expenses-btn').addEventListener('click',()=>this.clearAllExpenses()),document.getElementById('confirm-settlement').addEventListener('click',()=>this.confirmSettlement()),document.getElementById('cancel-settlement').addEventListener('click',()=>this.hideSettlementModal()),document.querySelector('.close-modal').addEventListener('click',()=>this.hideSettlementModal())}setTodayDate(){const t=new Date().toISOString().split('T')[0];document.getElementById('expense-date').value=t}addFriend(){const t=document.getElementById('friend-name'),e=t.value.trim();if(!e)return void this.showNotification('Please enter a friend\'s name','error');if(this.getCurrentGroupFriends().some(t=>t.name.toLowerCase()===e.toLowerCase()))return void this.showNotification('Friend already exists in this group','error');const a={id:Date.now(),name:e,groupId:this.currentGroupId,createdAt:new Date};this.friends.push(a),this.saveToStorage(),t.value='',this.displayFriends(),this.updatePaidByOptions(),this.updateSplitDetails(),this.updateGroupStats(),this.showNotification(`${e} added to ${this.getCurrentGroupName()}!`,'success')}getCurrentGroupName(){const t=this.groups.find(t=>t.id===this.currentGroupId);return t?t.name:'Default Group'}removeFriend(t){const e=this.friends.find(e=>e.id===t);if(!e)return;const a=this.expenses.some(a=>a.paidBy===t||Object.keys(a.splits).includes(t.toString()));if(a)return void this.showNotification('Cannot remove friend with existing expenses','error');confirm(`Remove ${e.name} from the group?`)&&(this.friends=this.friends.filter(e=>e.id!==t),this.saveToStorage(),this.displayFriends(),this.updatePaidByOptions(),this.updateSplitDetails(),this.showNotification(`${e.name} removed successfully!`,'success'))}displayFriends(){const t=document.getElementById('friends-list'),e=this.getCurrentGroupFriends();if(0===e.length)return void(t.innerHTML=`<div class="empty-state"><i class="fas fa-user-plus"></i><p>Add friends to ${this.getCurrentGroupName()}</p></div>`);t.innerHTML=e.map(t=>`<div class="friend-card"><div class="friend-info"><div class="friend-avatar">${t.name.charAt(0).toUpperCase()}</div><div class="friend-name-text">${t.name}</div></div><button class="btn btn-danger btn-small" onclick="splitter.removeFriend(${t.id})"><i class="fas fa-times"></i></button></div>`).join('')}updatePaidByOptions(){const t=document.getElementById('expense-paidby');t.innerHTML='<option value="">Select who paid</option>',this.getCurrentGroupFriends().forEach(e=>{const a=document.createElement('option');a.value=e.id,a.textContent=e.name,t.appendChild(a)})}updateSplitDetails(){const t=this.getCurrentGroupFriends();if(0===t.length)return void(document.getElementById('split-details').innerHTML=`<div class="empty-state"><i class="fas fa-users"></i><p>Add friends to ${this.getCurrentGroupName()} first</p></div>`);const e=document.querySelector('input[name="split-type"]:checked').value,a=parseFloat(document.getElementById('expense-amount').value)||0,i=document.getElementById('split-details');let r='<h4>Split breakdown:</h4>';if('equal'===e){const e=a/t.length;r+=t.map(t=>`<div class="split-item"><span class="friend-name">${t.name}</span><span class="split-amount">â‚¹${e.toFixed(2)}</span></div>`).join('')}else'percentage'===e?(r+=t.map(t=>`<div class="split-item"><span class="friend-name">${t.name}</span><input type="number" class="split-input" data-friend-id="${t.id}" placeholder="%" min="0" max="100" step="0.1"><span class="split-amount" id="amount-${t.id}">â‚¹0.00</span></div>`).join(''),r+=`<div class="split-item" style="border-top:2px solid #ff9a9e;font-weight:bold;"><span>Total Percentage:</span><span id="total-percentage">0%</span><span class="split-amount">â‚¹${a.toFixed(2)}</span></div>`):'custom'===e&&(r+=t.map(t=>`<div class="split-item"><span class="friend-name">${t.name}</span><input type="number" class="split-input" data-friend-id="${t.id}" placeholder="Amount" min="0" step="0.01"><span class="split-amount">â‚¹</span></div>`).join(''),r+=`<div class="split-item" style="border-top:2px solid #ff9a9e;font-weight:bold;"><span>Total Split:</span><span id="total-split-amount">â‚¹0.00</span><span class="split-amount">â‚¹${a.toFixed(2)}</span></div>`);if(i.innerHTML=r,'percentage'===e)document.querySelectorAll('.split-input').forEach(t=>t.addEventListener('input',()=>this.calculatePercentageSplits(a)));else'custom'===e&&document.querySelectorAll('.split-input').forEach(t=>t.addEventListener('input',()=>this.calculateCustomSplits()))}calculatePercentageSplits(t){let e=0;document.querySelectorAll('.split-input').forEach(a=>{const i=parseFloat(a.value)||0,r=a.dataset.friendId,o=t*i/100;document.getElementById(`amount-${r}`).textContent=`â‚¹${o.toFixed(2)}`,e+=i});const a=document.getElementById('total-percentage');a.textContent=`${e.toFixed(1)}%`,a.style.color=100===e?'#28a745':'#dc3545'}calculateCustomSplits(){let t=0;document.querySelectorAll('.split-input').forEach(e=>{t+=parseFloat(e.value)||0});const e=document.getElementById('total-split-amount');e.textContent=`â‚¹${t.toFixed(2)}`;const a=parseFloat(document.getElementById('expense-amount').value)||0;e.style.color=Math.abs(t-a)<.01?'#28a745':'#dc3545'}addExpense(){const t=document.getElementById('expense-description').value.trim(),e=parseFloat(document.getElementById('expense-amount').value),a=parseInt(document.getElementById('expense-paidby').value),i=document.getElementById('expense-date').value,r=document.getElementById('expense-group').value,o=document.getElementById('expense-category').value,n=document.querySelector('input[name="split-type"]:checked').value;if(!t||!e||!a||!i||!r)return void this.showNotification('Please fill in all required fields','error');if(!(e>0))return void this.showNotification('Amount must be greater than 0','error');if(0===this.getCurrentGroupFriends().length)return void this.showNotification('Add friends to the group first','error');const s=this.calculateSplits(n,e);if(!s)return;const l={id:Date.now(),description:t,amount:e,paidBy:a,date:new Date(i),groupId:r,category:o||'miscellaneous',splitType:n,splits:s,createdAt:new Date};this.expenses.push(l),this.saveToStorage(),this.clearExpenseForm(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.updateGroupStats(),this.showNotification('Expense added and split successfully!','success')}calculateSplits(t,e){const a={},i=this.getCurrentGroupFriends();if('equal'===t){const t=e/i.length;i.forEach(e=>a[e.id]=t)}else if('percentage'===t){let t=0;document.querySelectorAll('.split-input').forEach(i=>{const r=parseFloat(i.value)||0;t+=r;const o=parseInt(i.dataset.friendId);a[o]=e*r/100}),Math.abs(t-100)>.1&&(this.showNotification('Percentages must add up to 100%','error'),console.log('percent total',t),console.log('splits',a),console.log('amount',e),console.log('friends length',i.length),console.log('raw inputs',Array.from(document.querySelectorAll('.split-input')).map(t=>t.value)),console.log('debug meta',{type:t,total:e,friends:i.length}))}else if('custom'===t){let t=0;document.querySelectorAll('.split-input').forEach(i=>{const r=parseFloat(i.value)||0;t+=r;const o=parseInt(i.dataset.friendId);a[o]=r}),Math.abs(t-e)>.01&&(this.showNotification('Split amounts must equal the total expense','error'),console.warn('Custom split mismatch',{entered:t,total:e,splits:a}))}return a}displayExpenses(){const t=document.getElementById('expenses-history'),e=this.getFilteredExpenses();if(0===e.length)return void(t.innerHTML='<div class="empty-state"><i class="fas fa-receipt"></i><p>No expenses found matching your filters</p></div>');const a=[...e].sort((t,e)=>new Date(e.date)-new Date(t.date));t.innerHTML=a.map(t=>{const e=this.friends.find(e=>e.id===t.paidBy),a=this.groups.find(e=>e.id===t.groupId),i=Object.entries(t.splits).map(([t,i])=>{const r=this.friends.find(e=>e.id===parseInt(t));return r?`${r.name}: â‚¹${i.toFixed(2)}`:''}).filter(Boolean).join(', ');return `<div class="expense-item"><div class="expense-header"><div class="expense-title">${t.description}</div><div class="expense-amount-large">â‚¹${t.amount.toFixed(2)}</div></div><div class="expense-meta"><div class="meta-item"><i class="fas fa-calendar"></i>${this.formatDate(t.date)}</div><div class="meta-item"><i class="fas fa-layer-group"></i>${a?a.name:'Unknown Group'}</div><div class="meta-item"><i class="fas fa-tag"></i>${this.getCategoryName(t.category)}</div><div class="meta-item"><i class="fas fa-user"></i>Paid by ${e?e.name:'Unknown'}</div><div class="meta-item"><i class="fas fa-scissors"></i>${this.getSplitTypeText(t.splitType)}</div></div><div class="splits-summary"><div class="splits-title">Split Details:</div><div class="split-list">${i}</div></div></div>`}).join('')}getFilteredExpenses(){let t=[...this.expenses];const e=document.getElementById('filter-group').value;if('current'===e?t=t.filter(t=>t.groupId===this.currentGroupId):'all'!==e&&(t=t.filter(t=>t.groupId===e)),'all'!==(e=document.getElementById('filter-category').value)&&(t=t.filter(t=>t.category===e)),'all'!==(e=document.getElementById('filter-date-range').value)){const a=new Date;let i;'week'===e?i=new Date(a.getTime()-6048e5):'month'===e&&(i=new Date(a.getTime()-2592e6)),i&&(t=t.filter(t=>new Date(t.date)>=i))}return t}getSplitTypeText(t){return{equal:'Split Equally',percentage:'By Percentage',custom:'Custom Amounts'}[t]||t}updateBalanceSummary(){const t=this.calculateBalances(),e=document.getElementById('balance-summary'),a=Object.entries(t).filter(([t,e])=>Math.abs(e)>.01);if(0===a.length)return void(e.innerHTML='<div class="empty-state"><i class="fas fa-balance-scale"></i><p>All balances are settled! ðŸŽ‰</p></div>');e.innerHTML=a.map(([t,e])=>{const a=this.friends.find(e=>e.id===parseInt(t));if(!a)return'';const i=e>0,r=Math.abs(e);return `<div class="balance-card ${i?'owed':'owes'}"><div class="balance-header"><div class="balance-icon ${i?'owed':'owes'}"><i class="fas fa-${i?'arrow-up':'arrow-down'}"></i></div><div class="balance-title">${a.name}</div></div><div class="balance-amount ${i?'owed':'owes'}">â‚¹${r.toFixed(2)}</div><div class="balance-details">${i?'Should receive':'Owes to others'}</div></div>`}).join('')}calculateBalances(){const t={};this.getCurrentGroupFriends().forEach(e=>t[e.id]=0),this.getCurrentGroupExpenses().forEach(e=>{void 0!==t[e.paidBy]&&(t[e.paidBy]+=e.amount),Object.entries(e.splits).forEach(([e,a])=>{const i=parseInt(e);void 0!==t[i]&&(t[i]-=a)})}),this.settlements.filter(t=>{const e=this.friends.find(e=>e.id===t.payer),a=this.friends.find(e=>e.id===t.payee);return e?.groupId===this.currentGroupId&&a?.groupId===this.currentGroupId}).forEach(e=>{void 0!==t[e.payer]&&(t[e.payer]-=e.amount),void 0!==t[e.payee]&&(t[e.payee]+=e.amount)});return t}updateSettlementSuggestions(){const t=this.calculateBalances(),e=document.getElementById('settlement-suggestions'),a=[],i=[];Object.entries(t).forEach(([t,e])=>{e<-0.01?a.push({id:parseInt(t),amount:Math.abs(e)}):e>0.01&&i.push({id:parseInt(t),amount:e})});if(0===a.length&&0===i.length)return void(e.innerHTML='<div class="empty-state"><i class="fas fa-handshake"></i><p>All debts are settled! ðŸŽ‰</p></div>');const r=this.generateSettlementSuggestions(a,i);e.innerHTML=r.map(t=>{const e=this.friends.find(e=>e.id===t.payer),a=this.friends.find(e=>e.id===t.payee);return `<div class="settlement-card"><div class="settlement-info"><h4>${e.name} â†’ ${a.name}</h4><p>Settle debt</p></div><div class="settlement-amount">â‚¹${t.amount.toFixed(2)}</div><button class="btn btn-primary btn-small" onclick="splitter.showSettlementModal(${t.payer},${t.payee},${t.amount})"><i class="fas fa-handshake"></i> Settle</button></div>`}).join('')}generateSettlementSuggestions(t,e){const a=[],i=[...t],r=[...e];for(;i.length>0&&r.length>0;){const t=i[0],e=r[0],o=Math.min(t.amount,e.amount);a.push({payer:t.id,payee:e.id,amount:o}),t.amount-=o,e.amount-=o,t.amount<.01&&i.shift(),e.amount<.01&&r.shift()}return a}showSettlementModal(t,e,a){const i=this.friends.find(e=>e.id===t),r=this.friends.find(t=>t.id===e);document.getElementById('settlement-details').textContent=`${i.name} will pay â‚¹${a.toFixed(2)} to ${r.name}`,this.pendingSettlement={payer:t,payee:e,amount:a},document.getElementById('settlement-modal').classList.remove('hidden')}hideSettlementModal(){document.getElementById('settlement-modal').classList.add('hidden'),this.pendingSettlement=null}confirmSettlement(){if(!this.pendingSettlement)return;const t={id:Date.now(),...this.pendingSettlement,date:new Date,createdAt:new Date};this.settlements.push(t),this.saveToStorage(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.hideSettlementModal();const e=this.friends.find(e=>e.id===t.payer),a=this.friends.find(e=>e.id===t.payee);this.showNotification(`Settlement recorded: ${e.name} paid ${a.name} â‚¹${t.amount.toFixed(2)}`,'success')}formatDate(t){return new Date(t).toLocaleDateString('en-IN',{year:'numeric',month:'short',day:'numeric'})}clearExpenseForm(){document.getElementById('expense-form').reset(),this.setTodayDate(),document.getElementById('expense-group').value=this.currentGroupId,document.querySelector('input[name="split-type"][value="equal"]').checked=!0,this.updateSplitDetails()}exportExpenses(){if(0===this.expenses.length)return void this.showNotification('No expenses to export','error');const t=this.generateExpensesCSV();this.downloadCSV(t,`shared_expenses_${new Date().toISOString().split('T')[0]}.csv`),this.showNotification('Expenses exported successfully!','success')}exportBalanceSummary(){const t=this.calculateBalances();if(!Object.values(t).some(t=>Math.abs(t)>.01))return void this.showNotification('No balances to export - everyone is settled!','error');const e=this.generateBalanceSummaryCSV(t);this.downloadCSV(e,`balance_summary_${new Date().toISOString().split('T')[0]}.csv`),this.showNotification('Balance summary exported successfully!','success')}exportExpenseSummary(){if(0===this.expenses.length)return void this.showNotification('No expenses to export','error');const t=this.generateExpenseSummaryCSV();this.downloadCSV(t,`expense_summary_${new Date().toISOString().split('T')[0]}.csv`),this.showNotification('Expense summary exported successfully!','success')}exportAllData(){if(0===this.friends.length&&0===this.expenses.length)return void this.showNotification('No data to export','error');const t={exportDate:new Date().toISOString(),friends:this.friends,expenses:this.expenses,settlements:this.settlements,balances:this.calculateBalances(),summary:this.generateDataSummary()},e=JSON.stringify(t,null,2),a=new Blob([e],{type:'application/json'}),i=URL.createObjectURL(a),r=document.createElement('a');r.href=i,r.download=`expense_splitter_backup_${new Date().toISOString().split('T')[0]}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),this.showNotification('Complete data backup exported successfully!','success')}importData(t){if(!t)return void this.showNotification('Please select a file to import','error');if(!t.name.endsWith('.json'))return void this.showNotification('Please select a valid JSON backup file','error');const e=new FileReader;e.onload=a=>{try{const e=JSON.parse(a.target.result);if(!this.validateImportedData(e))return void this.showNotification('Invalid backup file format','error');if(!confirm(`Import data from ${t.name}? This will replace current data.`))return;this.createAutomaticBackup(),this.friends=e.friends||[],this.expenses=e.expenses||[],this.settlements=e.settlements||[],this.expenses.forEach(t=>{t.date=new Date(t.date),t.createdAt=new Date(t.createdAt)}),this.settlements.forEach(t=>{t.date=new Date(t.date),t.createdAt=new Date(t.createdAt)}),this.friends.forEach(t=>{t.createdAt=new Date(t.createdAt)}),this.saveToStorage(),this.displayFriends(),this.updatePaidByOptions(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.updateSplitDetails(),this.showNotification('Data imported successfully!','success')}catch(t){console.error('Error importing data:',t),this.showNotification('Error reading backup file. File may be corrupted.','error')}};e.onerror=()=>this.showNotification('Error reading file','error'),e.readAsText(t),document.getElementById('import-file-input').value=''}validateImportedData(t){return t&&((void 0!==t.friends&&void 0!==t.expenses)||Array.isArray(t.friends)||Array.isArray(t.expenses))}generateExpensesCSV(){const t=['Date','Group','Category','Description','Amount','Paid By','Split Type','Friend','Share Amount'],e=[];return this.expenses.forEach(a=>{const i=this.friends.find(t=>t.id===a.paidBy),r=this.groups.find(t=>t.id===a.groupId);Object.entries(a.splits).forEach(([o,n])=>{const s=this.friends.find(t=>t.id===parseInt(o));e.push([this.formatDate(a.date),r?r.name:'Unknown Group',this.getCategoryName(a.category),a.description,a.amount.toFixed(2),i?i.name:'Unknown',this.getSplitTypeText(a.splitType),s?s.name:'Unknown',n.toFixed(2)])})}),[t,...e].map(t=>t.map(t=>`"${t}"`).join(',')).join('\n')}generateExpenseSummaryCSV(){const t=['Friend Name','Group','Total Paid','Total Share','Net Balance','Number of Expenses'],e=[];e.push(['Expense Summary Report','','','','',`Generated on: ${new Date().toLocaleString()}`]),e.push(['','','','','','']);const a={};this.expenses.forEach(t=>{const e=this.groups.find(e=>e.id===t.groupId),i=e?e.name:'Unknown Group';Object.entries(t.splits).forEach(([e,r])=>{const o=this.friends.find(t=>t.id===parseInt(e));if(o){const n=`${o.name}_${i}`;a[n]||(a[n]={name:o.name,group:i,totalPaid:0,totalShare:0,expenseCount:0}),a[n].totalShare+=r,a[n].expenseCount+=1,t.paidBy===parseInt(e)&&(a[n].totalPaid+=t.amount)}})}),Object.values(a).forEach(a=>{const i=a.totalPaid-a.totalShare;e.push([a.name,a.group,`â‚¹${a.totalPaid.toFixed(2)}`,`â‚¹${a.totalShare.toFixed(2)}`,`â‚¹${i.toFixed(2)}`,a.expenseCount.toString()])}),e.push(['','','','','','']),e.push(['GROUP SUMMARIES:','','','','','']);const i={};return this.expenses.forEach(t=>{const e=this.groups.find(e=>e.id===t.groupId),a=e?e.name:'Unknown Group';i[a]||(i[a]={totalAmount:0,expenseCount:0,uniquePeople:new Set}),i[a].totalAmount+=t.amount,i[a].expenseCount+=1,Object.keys(t.splits).forEach(e=>{const a=this.friends.find(t=>t.id===parseInt(e));a&&i[a].uniquePeople.add(a.name)})}),Object.entries(i).forEach(([t,a])=>{e.push([`${t} Total`,t,`â‚¹${a.totalAmount.toFixed(2)}`,`${a.expenseCount} expenses`,`${a.uniquePeople.size} people`,''])}),[t,...e].map(t=>t.map(t=>`"${t}"`).join(',')).join('\n')}getCategoryName(t){return{food:'Food & Dining',accommodation:'Accommodation',transportation:'Transportation',entertainment:'Entertainment',groceries:'Groceries',utilities:'Utilities',miscellaneous:'Miscellaneous'}[t]||'Miscellaneous'}generateBalanceSummaryCSV(t){const e=['Friend Name','Balance Amount','Status','Details'],a=[];a.push(['Balance Summary Report','','',`Generated on: ${new Date().toLocaleString()}`]),a.push(['','','','']);Object.entries(t).forEach(([t,i])=>{const r=this.friends.find(e=>e.id===parseInt(t));if(r){const t=Math.abs(i);if(!(t>.01))return;const e=i>0?'Should Receive':'Owes Others',o=i>0?`${r.name} should receive â‚¹${t.toFixed(2)} from others`:`${r.name} owes â‚¹${t.toFixed(2)} to others`;a.push([r.name,`â‚¹${t.toFixed(2)}`,e,o])}});const i=Object.fromEntries(Object.entries(t).filter(([t,e])=>Math.abs(e)>.01));if(Object.keys(i).length>0){a.push(['','','','']),a.push(['Settlement Suggestions:','','','']);const t=Object.entries(i).filter(([t,e])=>e<-.01).map(([t,e])=>({id:parseInt(t),amount:Math.abs(e)})),r=Object.entries(i).filter(([t,e])=>e>.01).map(([t,e])=>({id:parseInt(t),amount:e})),o=this.generateSettlementSuggestions(t,r);o.forEach((t,e)=>{const i=this.friends.find(e=>e.id===t.payer),r=this.friends.find(e=>e.id===t.payee);a.push([`Settlement ${e+1}`,`â‚¹${t.amount.toFixed(2)}`,'Payment Needed',`${i.name} should pay ${r.name} â‚¹${t.amount.toFixed(2)}`])})}return[e,...a].map(t=>t.map(t=>`"${t}"`).join(',')).join('\n')}generateDataSummary(){const t=this.calculateBalances(),e=this.expenses.reduce((t,e)=>t+e.amount,0),a=this.settlements.reduce((t,e)=>t+e.amount,0);return{totalFriends:this.friends.length,totalExpenses:this.expenses.length,totalExpenseAmount:e,totalSettlements:this.settlements.length,totalSettlementAmount:a,outstandingBalances:Object.values(t).filter(t=>Math.abs(t)>.01).length,lastUpdate:new Date().toISOString()}}downloadCSV(t,e){const a=new Blob([t],{type:'text/csv;charset=utf-8;'}),i=URL.createObjectURL(a),r=document.createElement('a');r.href=i,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}clearAllExpenses(){if(0===this.expenses.length&&0===this.settlements.length)return void this.showNotification('No data to clear','error');confirm('Delete ALL expenses and settlements? This cannot be undone.')&&(this.expenses=[],this.settlements=[],this.saveToStorage(),this.displayExpenses(),this.updateBalanceSummary(),this.updateSettlementSuggestions(),this.showNotification('All data cleared successfully!','success'))}saveToStorage(){this.autoSaveEnabled&&this.fileStorage.isReady()&&this.saveToFile();try{localStorage.setItem('splitter_groups',JSON.stringify(this.groups)),localStorage.setItem('splitter_friends',JSON.stringify(this.friends)),localStorage.setItem('splitter_expenses',JSON.stringify(this.expenses)),localStorage.setItem('splitter_settlements',JSON.stringify(this.settlements)),localStorage.setItem('splitter_currentGroup',this.currentGroupId);const t={lastSaved:new Date().toISOString(),dataVersion:'2.0',totalRecords:{groups:this.groups.length,friends:this.friends.length,expenses:this.expenses.length,settlements:this.settlements.length},checksum:this.generateDataChecksum()};localStorage.setItem('splitter_metadata',JSON.stringify(t))}catch(t){console.error('Error saving to localStorage:',t),this.fileStorage.isReady()||this.showNotification('Error saving data. Please choose a folder location.','error')}}generateDataChecksum(){return JSON.stringify({friends:this.friends,expenses:this.expenses,settlements:this.settlements}).length.toString()}async createAutomaticBackup(){}loadFromStorage(){try{this.groups=JSON.parse(localStorage.getItem('splitter_groups')||'[]'),this.friends=JSON.parse(localStorage.getItem('splitter_friends')||'[]'),this.expenses=JSON.parse(localStorage.getItem('splitter_expenses')||'[]'),this.settlements=JSON.parse(localStorage.getItem('splitter_settlements')||'[]'),this.currentGroupId=localStorage.getItem('splitter_currentGroup')||'default',this.validateDataIntegrity(),this.expenses.forEach(t=>{t.date&& (t.date=new Date(t.date)),t.createdAt&&(t.createdAt=new Date(t.createdAt)),t.groupId||(t.groupId='default'),t.category||(t.category='miscellaneous')}),this.settlements.forEach(t=>{t.date&&(t.date=new Date(t.date)),t.createdAt&&(t.createdAt=new Date(t.createdAt))}),this.friends.forEach(t=>{t.createdAt&&(t.createdAt=new Date(t.createdAt)),t.groupId||(t.groupId='default')}),this.groups.forEach(t=>{t.createdAt&&(t.createdAt=new Date(t.createdAt))})}catch(t){console.error('Error loading from localStorage:',t),this.groups=[],this.friends=[],this.expenses=[],this.settlements=[],this.currentGroupId='default'}}validateDataIntegrity(){const t=JSON.parse(localStorage.getItem('splitter_metadata')||'{}');t.checksum&&this.generateDataChecksum()!==t.checksum&&console.warn('Data integrity check failed.'),Array.isArray(this.friends)||(this.friends=[]),Array.isArray(this.expenses)||(this.expenses=[]),Array.isArray(this.settlements)||(this.settlements=[]),this.friends=this.friends.filter(t=>t&&t.id&&t.name),this.expenses=this.expenses.filter(t=>t&&t.id&&t.amount&&t.paidBy),this.settlements=this.settlements.filter(t=>t&&t.id&&t.payer&&t.payee&&t.amount)}showNotification(t,e){const a=document.getElementById('notification');a.textContent=t,a.className=`notification ${e}`,a.classList.remove('hidden'),setTimeout(()=>{a.classList.add('show')},100),setTimeout(()=>{a.classList.remove('show'),setTimeout(()=>a.classList.add('hidden'),300)},4e3)}}let splitter;document.addEventListener('DOMContentLoaded',()=>{splitter=new ExpenseSplitter,splitter.updateCategoryChart&&splitter.updateCategoryChart()}),document.addEventListener('DOMContentLoaded',()=>{const t=localStorage.getItem('splitter_friends');if(!t){const t=[{id:1,name:'Alice',createdAt:new Date},{id:2,name:'Bob',createdAt:new Date},{id:3,name:'Charlie',createdAt:new Date}];localStorage.setItem('splitter_friends',JSON.stringify(t))}}),ExpenseSplitter.prototype.updateCategoryChart=function(){const t=document.getElementById('group-category-chart');if(!t)return;const e=t.getContext('2d'),a=this.getCurrentGroupExpenses(),i={};a.forEach(t=>{const e=t.category||'miscellaneous';i[e]=(i[e]||0)+t.amount});const r=Object.keys(i),o=Object.values(i);if(this.categoryChart&&this.categoryChart.destroy(),0===o.length)return e.clearRect(0,0,t.width,t.height),e.font='16px Segoe UI',e.fillStyle='#666',e.textAlign='center',void e.fillText('No category data yet',t.width/2,t.height/2);const n={rent:'#FF6384',groceries:'#36A2EB',utilities:'#FFCE56',transportation:'#4BC0C0',food:'#9966FF',entertainment:'#FF9F40',healthcare:'#8BC34A',education:'#795548',miscellaneous:'#C9CBCF'},s=r.map(t=>n[t]||'#888');this.categoryChart=new Chart(e,{type:'doughnut',data:{labels:r.map(t=>this.getCategoryName(t)),datasets:[{data:o,backgroundColor:s,borderWidth:2,borderColor:'#fff'}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:'bottom',labels:{usePointStyle:!0}},tooltip:{callbacks:{label:t=>{const e=t.dataset.data.reduce((t,e)=>t+e,0),a=(t.parsed/e*100).toFixed(1);return `${t.label}: â‚¹${t.parsed.toFixed(2)} (${a}%)`}}}}}})},['displayExpenses','switchGroup','addExpense'].forEach(t=>{const e=ExpenseSplitter.prototype[t];ExpenseSplitter.prototype[t]=function(...a){const i=e.apply(this,a);return this.updateCategoryChart(),i}});
